name: Build DhakaFlix 2

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Gemini Intelligence
        run: |
          echo "ü§ñ Gemini CLI is active and taking control of this build."
          echo "üì° Mode: Cloud-Native Auto-Development"
          echo "üîê Signing: Permanent Personal Key (Update-Ready)"
          echo "üßπ Cleanup Policy: Automated (No Junk left on failure)"
          echo "üü¢ System Check: OK"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build with Gradle
        id: build
        run: chmod +x gradlew && ./gradlew assembleRelease --no-daemon

      - name: Gemini Auto-Remediation (Failure Cleanup)
        if: failure()
        run: |
          echo "‚ùå Build failed. Cleaning up 'junk' changes to keep repository stable..."
          git reset --hard HEAD
          echo "üßπ All local changes reverted. No junk left."

      - name: Sign APK (Permanent Key)
        if: success()
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: src/all/dhakaflix2/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "36.0.0"

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}

      - name: Create Release
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}-gemini
          name: DhakaFlix 2 Gemini Optimized v${{ github.run_number }}
          body: |
            ### ü§ñ Automated Gemini Build
            - **Robust Search:** Parallel probing across multiple servers.
            - **Stability:** Fixed parsing regressions and URL normalization.
            - **Security:** Signed with Permanent Key.
            - **Status:** Build Successful & Clean
          files: ${{ steps.sign_app.outputs.signedReleaseFile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to Extensions Repo
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          REPO_DIR="extensions-repo-tmp"
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/salmanbappi/extensions-repo.git $REPO_DIR
          
          PKG_NAME="eu.kanade.tachiyomi.animeextension.all.dhakaflix2"
          VERSION_CODE=$(grep "extVersionCode =" src/all/dhakaflix2/build.gradle | awk '{print $3}')
          VERSION_NAME="14.$VERSION_CODE"
          TARGET_NAME="$PKG_NAME-v$VERSION_NAME-c$VERSION_CODE.apk"
          
          mkdir -p $REPO_DIR/apk
          cp ${{ steps.sign_app.outputs.signedReleaseFile }} $REPO_DIR/apk/$TARGET_NAME
          
          cd $REPO_DIR
          git config user.name "Gemini Automation"
          git config user.email "gemini@automation.bot"
          git add apk/$TARGET_NAME
          
          # Update index via generate script in the repo
          python generate_repo.py
          git add index.min.json repo.json
          
          git commit -m "Update DhakaFlix 2 to v$VERSION_NAME"
          git push
